<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gabriel IA - Chat Inteligente</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Estilos mantidos da vers√£o anterior */
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #60a5fa;
            --background-color: #f8fafc;
            --text-color: #1e293b;
            --ai-bubble: #ffffff;
            --user-bubble: #2563eb;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .chat-header h1 {
            font-weight: 600;
            font-size: 1.5rem;
        }

        .chat-header p {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .chat-container {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: #f8fafc;
        }

        .message {
            max-width: 70%;
            padding: 1rem 1.25rem;
            border-radius: 1.5rem;
            display: flex;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }

        .ai-message {
            background: var(--ai-bubble);
            align-self: flex-start;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }

        .user-message {
            background: var(--user-bubble);
            color: white;
            align-self: flex-end;
        }

        .input-container {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e2e8f0;
            position: relative;
        }

        .input-wrapper {
            display: flex;
            gap: 0.5rem;
            position: relative;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 1rem 1.25rem;
            border: 1px solid #e2e8f0;
            border-radius: 1rem;
            font-size: 1rem;
            transition: all 0.2s;
            padding-right: 4rem;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        button {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover {
            background: var(--secondary-color);
            transform: translateY(-50%) scale(0.98);
        }

        .typing-indicator {
            display: none;
            padding: 1rem;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-color);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.75rem;
            margin: 1rem;
            display: none;
            align-items: center;
            gap: 0.75rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typing {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-header">
            <div class="avatar">GR</div>
            <div class="header-content">
                <h1>Gabriel IA</h1>
                <p>Assistente inteligente baseado em Gabriel Ricardo</p>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai-message">
                <div class="avatar">IA</div>
                <div>Ol√°! Sou o Gabriel Ricardo, como posso ajudar voc√™ hoje? üòä</div>
            </div>
        </div>

        <div class="error-message" id="errorMessage">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span id="errorText"></span>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dot"></div>
            <div class="typing-dot" style="animation-delay: 0.2s"></div>
            <div class="typing-dot" style="animation-delay: 0.4s"></div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="Escreva sua mensagem..." autocomplete="off">
                <button onclick="sendMessage()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" width="20">
                        <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'AIzaSyAbW9rQgbja14vDUsXuKnjvl2MalzdYg9E';
        const MAX_RETRIES = 2;
        const TIMEOUT = 25000;

        let chatHistory = [];
        let isProcessing = false;

        async function init() {
            try {
                const [profile, chat] = await Promise.all([
                    fetch('profile.txt').then(r => r.text()),
                    fetch('chat.txt').then(r => r.text())
                ]);

                chatHistory = [
                    { 
                        role: "user", 
                        parts: [{ text: `Perfil do Gabriel:\n${profile}\n\nHist√≥rico de Conversas:\n${chat}` }]
                    },
                    { 
                        role: "model", 
                        parts: [{ text: "Ol√°! Sou o Gabriel Ricardo." }]
                    }
                ];
            } catch (error) {
                showError('Erro ao carregar dados iniciais: ' + error.message);
            }
        }

        async function sendMessage() {
            if (isProcessing) return;
            
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            if (!message) return;

            isProcessing = true;
            userInput.disabled = true;
            showTyping(true);
            clearError();

            try {
                addMessage(message, 'user');
                userInput.value = '';

                const response = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [
                                ...chatHistory,
                                { role: "user", parts: [{ text: message }] }
                            ],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 1500
                            }
                        })
                    },
                    MAX_RETRIES
                );

                const data = await parseResponse(response);
                
                if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                    throw new Error('Resposta da API em formato inv√°lido');
                }

                const aiResponse = data.candidates[0].content.parts[0].text;
                
                addMessage(aiResponse, 'ai');
                updateChatHistory(message, aiResponse);

            } catch (error) {
                handleError(error, message);
            } finally {
                isProcessing = false;
                userInput.disabled = false;
                showTyping(false);
            }
        }

        async function fetchWithRetry(url, options, retries) {
            const controller = new AbortController();
            options.signal = controller.signal;
            
            try {
                const timeoutId = setTimeout(() => controller.abort(), TIMEOUT);
                const response = await fetch(url, options);
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }
                return response;

            } catch (error) {
                if (retries > 0 && !error.message.includes('400')) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    return fetchWithRetry(url, options, retries - 1);
                }
                throw error;
            }
        }

        async function parseResponse(response) {
            try {
                return await response.json();
            } catch (error) {
                throw new Error('Resposta inv√°lida do servidor');
            }
        }

        function updateChatHistory(userMessage, aiMessage) {
            chatHistory.push(
                { role: "user", parts: [{ text: userMessage }] },
                { role: "model", parts: [{ text: aiMessage }] }
            );
            
            if (chatHistory.length > 20) {
                chatHistory = chatHistory.slice(-10);
            }
        }

        function handleError(error, originalMessage) {
            console.error('Erro detalhado:', error);
            
            let errorMessage = 'Erro desconhecido';
            const errorString = error.message.toLowerCase();

            if (errorString.includes('aborted')) {
                errorMessage = 'Tempo de resposta excedido. Tente novamente.';
            } else if (errorString.includes('network')) {
                errorMessage = 'Erro de conex√£o. Verifique sua internet.';
            } else if (errorString.includes('api key')) {
                errorMessage = 'Problema de autentica√ß√£o. API Key inv√°lida.';
            } else if (errorString.includes('400')) {
                errorMessage = 'Solicita√ß√£o inv√°lida. Reformule sua mensagem.';
            } else if (errorString.includes('429')) {
                errorMessage = 'Muitas requisi√ß√µes. Aguarde um momento.';
            }

            showError(errorMessage);
            document.getElementById('userInput').value = originalMessage;
        }

        function addMessage(text, sender) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = `
                <div class="avatar">${sender === 'ai' ? 'IA' : 'Voc√™'}</div>
                <div>${text}</div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTyping(show) {
            document.getElementById('typingIndicator').style.display = 
                show ? 'flex' : 'none';
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorElement.style.display = 'flex';
        }

        function clearError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        document.getElementById('userInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        init();
    </script>
</body>
</html>